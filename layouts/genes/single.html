{{ define "main" }}
{{/* Look up disease status from gene_index */}}
{{ $symbol := .Params.symbol }}
{{ $hasDisease := false }}
{{ range .Site.Data.gene_index }}
    {{ if eq .symbol $symbol }}
        {{ $hasDisease = .has_disease }}
    {{ end }}
{{ end }}

<div id="gene-app" v-cloak>
    <!-- Header -->
    <div class="mb-8 border-b border-slate-200 pb-4">
        <div class="flex items-center justify-between">
            <h1 class="text-4xl font-bold text-primary mb-2">{{ .Params.symbol }}</h1>
            {{ if $hasDisease }}
            <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-rose-50 border border-rose-200 text-rose-700 text-sm font-medium rounded-lg">
                <span class="w-2.5 h-2.5 bg-rose-500 rounded-full"></span>
                Human Disease Associated
            </span>
            {{ end }}
        </div>
        <p class="text-xl text-slate-500 italic">{{ .Params.name | default "(No descriptive name provided)" }}</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Column 1: Metadata (3 cols) -->
        <div class="lg:col-span-3 space-y-6">

            <!-- Gene Information -->
            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Gene Information</h3>
                <dl class="space-y-4">
                    {{ if or .Params.aliases .Params.synonyms }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Aliases</dt>
                        <dd class="mt-1 text-sm text-slate-700">
                            {{ if .Params.aliases }}
                            {{ delimit .Params.aliases ", " }}
                            {{ else }}
                            {{ .Params.synonyms }}
                            {{ end }}
                        </dd>
                    </div>
                    {{ end }}
                    {{ with .Params.gene_type }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Type</dt>
                        <dd class="mt-1 text-sm text-slate-700">{{ . }}</dd>
                    </div>
                    {{ end }}
                    {{ with .Params.genomic_location }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Location</dt>
                        <dd class="mt-1 text-sm text-slate-700">{{ . }}</dd>
                    </div>
                    {{ end }}
                    {{ with .Params.species }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Species</dt>
                        <dd class="mt-1 text-sm text-slate-700 italic">{{ . }}</dd>
                    </div>
                    {{ end }}
                </dl>
            </div>

            <!-- Sequence Information -->
            {{ if .Params.sequences }}
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Sequence Information</h3>
                <dl class="space-y-4">
                    {{ with .Params.sequences.rna }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">RNA (RefSeq)</dt>
                        <dd class="mt-1 text-sm text-slate-700 font-mono">
                            <a href="https://www.ncbi.nlm.nih.gov/nuccore/{{ . }}" target="_blank"
                                class="text-primary hover:underline">{{ . }}</a>
                        </dd>
                    </div>
                    {{ end }}
                    {{ with .Params.sequences.protein }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Protein (RefSeq)</dt>
                        <dd class="mt-1 text-sm text-slate-700 font-mono">
                            <a href="https://www.ncbi.nlm.nih.gov/protein/{{ . }}" target="_blank"
                                class="text-primary hover:underline">{{ . }}</a>
                        </dd>
                    </div>
                    {{ end }}
                </dl>
            </div>
            {{ end }}

            <!-- Phenotypes -->
            {{ if .Params.phenotypes }}
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Phenotypes</h3>
                <ul class="space-y-3">
                    {{ range .Params.phenotypes }}
                    <li class="text-sm text-slate-700">
                        <span class="font-medium">{{ .description }}</span>
                        {{ if .reference }}
                        <a href="https://pubmed.ncbi.nlm.nih.gov/{{ .reference }}" target="_blank"
                            class="text-xs text-primary hover:underline ml-1">[{{ .reference }}]</a>
                        {{ end }}
                    </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}

            <!-- Primer & Template Information -->
            {{ if or .Params.forward_primer .Params.reverse_primer .Params.template_length }}
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Primers & Probe</h3>
                <dl class="space-y-4">
                    {{ with .Params.forward_primer }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Forward Primer</dt>
                        <dd
                            class="mt-1 text-xs font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded border border-slate-200 break-all">
                            {{ . }}</dd>
                    </div>
                    {{ end }}
                    {{ with .Params.reverse_primer }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Reverse Primer</dt>
                        <dd
                            class="mt-1 text-xs font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded border border-slate-200 break-all">
                            {{ . }}</dd>
                    </div>
                    {{ end }}
                    {{ with .Params.template_length }}
                    <div>
                        <dt class="text-xs font-medium text-slate-500 uppercase">Template Length</dt>
                        <dd class="mt-1 text-sm text-slate-700">{{ . }} bp</dd>
                    </div>
                    {{ end }}
                </dl>
            </div>
            {{ end }}

            <!-- External Links -->
            {{ if or .Params.external_links .Params.external_ids }}
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">External Resources</h3>
                <ul class="space-y-3">
                    {{ range $key, $url := .Params.external_links }}
                    <li>
                        <a href="{{ $url }}" target="_blank" rel="noopener noreferrer"
                            class="flex items-center text-sm text-primary hover:text-primary-dark transition-colors group">
                            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-primary" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                </path>
                            </svg>
                            {{ $key }}
                        </a>
                    </li>
                    {{ end }}

                    {{ with .Params.external_ids.ensembl }}
                    <li>
                        <a href="http://www.ensembl.org/id/{{ . }}" target="_blank" rel="noopener noreferrer"
                            class="flex items-center text-sm text-primary hover:text-primary-dark transition-colors group">
                            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-primary" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                </path>
                            </svg>
                            Ensembl Gene
                        </a>
                    </li>
                    {{ end }}

                    {{ with .Params.ncbi_id }}
                    <li>
                        <a href="https://www.ncbi.nlm.nih.gov/gene/{{ . }}" target="_blank" rel="noopener noreferrer"
                            class="flex items-center text-sm text-primary hover:text-primary-dark transition-colors group">
                            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-primary" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                </path>
                            </svg>
                            NCBI Gene
                        </a>
                    </li>
                    {{ end }}

                    {{ with .Params.external_ids.kegg }}
                    <li>
                        <a href="http://www.genome.jp/dbget-bin/www_bget?{{ . }}" target="_blank"
                            rel="noopener noreferrer"
                            class="flex items-center text-sm text-primary hover:text-primary-dark transition-colors group">
                            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-primary" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                </path>
                            </svg>
                            KEGG
                        </a>
                    </li>
                    {{ end }}

                    {{ with .Params.external_ids.uniprot }}
                    <li>
                        <a href="https://www.uniprot.org/uniprot/{{ . }}" target="_blank" rel="noopener noreferrer"
                            class="flex items-center text-sm text-primary hover:text-primary-dark transition-colors group">
                            <svg class="w-4 h-4 mr-2 text-slate-400 group-hover:text-primary" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                </path>
                            </svg>
                            UniProt
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}

            <!-- Sources Section -->
            {{ $sources := slice }}
            {{ if .Params.sources }}
            {{ $sources = .Params.sources }}
            {{ end }}

            {{/* Collect sources from images */}}
            {{ range .Params.images }}
            {{ if .source }}
            {{ $sName := .source }}
            {{ $exists := false }}
            {{ range $sources }}
            {{ if eq .name $sName }}{{ $exists = true }}{{ end }}
            {{ end }}
            {{ if not $exists }}
            {{ $sUrl := "" }}
            {{ $sType := "publication" }}
            {{ $resolved := false }}

            {{/* Look up resolved PubMed link from papers.json */}}
            {{ $shortName := replace $sName " et al. " " " }}
            {{ range $.Site.Data.papers }}
            {{ if and (eq .citation $shortName) .resolved }}
            {{ $sUrl = .url }}
            {{ $resolved = true }}
            {{ end }}
            {{ end }}

            {{/* Fallback to search URL if not resolved */}}
            {{ if not $resolved }}
            {{ $sUrl = printf "https://pubmed.ncbi.nlm.nih.gov/?term=%s+chick" ($sName | urlquery) }}
            {{ end }}

            {{ $sources = $sources | append (dict "name" $sName "url" $sUrl "type" $sType "resolved" $resolved) }}
            {{ end }}
            {{ end }}
            {{ end }}

            {{/* Filter out NCBI Gene */}}
            {{ $finalSources := slice }}
            {{ range $sources }}
            {{ if ne .name "NCBI Gene" }}
            {{ $finalSources = $finalSources | append . }}
            {{ end }}
            {{ end }}

            {{ if gt (len $finalSources) 0 }}
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Data Sources</h3>
                <ul class="space-y-3">
                    {{ range $finalSources }}
                    <li>
                        <a href="{{ .url }}" target="_blank" rel="noopener noreferrer"
                            class="flex items-center p-3 rounded-lg border {{ if .resolved }}border-blue-300 bg-blue-50{{ else }}border-slate-200{{ end }} hover:border-primary hover:shadow-sm transition-all group">
                            <div class="mr-3 flex-shrink-0">
                                {{ if eq .type "database" }}
                                <div
                                    class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                                        </path>
                                    </svg>
                                </div>
                                {{ else if .resolved }}
                                <div
                                    class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: #007FFF;">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                {{ else }}
                                <div
                                    class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                {{ end }}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-slate-900 group-hover:text-primary">{{ replace .name " et al. " " " }}
                                </div>
                                <div class="text-xs text-slate-500">{{ if .resolved }}PubMed{{ else }}Search{{ end }}</div>
                            </div>
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}
        </div>

        <!-- Column 2: Image Gallery (6 cols) -->
        <div class="lg:col-span-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Expression Images</h2>
                <span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">
                    <span v-text="filteredImages.length"></span> images
                </span>
            </div>

            <!-- Gallery Grid -->
            <div v-if="filteredImages.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div v-for="(img, index) in filteredImages" :key="index"
                    class="group relative aspect-square bg-slate-200 rounded-lg overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all duration-200">
                    <a :href="img.url" class="glightbox block w-full h-full" :data-gallery="'gallery-' + geneId"
                        :data-title="img.stage + (img.locations.length ? ' - ' + img.locations.join(', ') : '')">
                        <img :src="img.url"
                            class="w-full h-full object-contain p-1 transition-transform duration-500 group-hover:scale-105"
                            loading="lazy" :alt="symbol + ' expression at ' + img.stage">
                        <div
                            class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex flex-col justify-end p-3">
                            <div class="mb-1">
                                <span v-if="img.source === 'GEISHA'"
                                    class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-100 text-blue-800">
                                    GEISHA
                                </span>
                                <span v-else
                                    class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-green-100 text-green-800">
                                    <span v-text="img.sourceLabel"></span>
                                </span>
                            </div>
                            <p class="text-white text-xs font-medium truncate" v-text="img.stage"></p>
                            <p class="text-slate-200 text-[10px] truncate" v-if="img.locations.length"
                                v-text="img.locations.join(', ')"></p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else class="bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 p-12 text-center">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-slate-900">No images found</h3>
                <p class="mt-1 text-sm text-slate-500">Try adjusting your filters.</p>
                <div class="mt-4 space-x-2">
                    <button v-if="activeLocations.length > 0" @click="clearLocations()"
                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-primary bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Clear Location
                    </button>
                    <button v-if="activeStages.length > 0" @click="clearStages()"
                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-primary bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Clear Stage
                    </button>
                </div>
            </div>
        </div>

        <!-- Column 3: Locations Filter (3 cols) - RIGHT SIDEBAR -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider">Filter by Location</h3>
                    <button v-if="activeLocations.length > 0" @click="clearLocations()"
                        class="text-xs text-primary hover:underline">Clear</button>
                </div>
                <div class="space-y-1">
                    <button v-for="loc in sortedLocations" :key="loc.name" @click="toggleLocation(loc.name)"
                        :class="activeLocations.includes(loc.name) ? 'bg-primary text-white' : 'bg-slate-50 text-slate-700 hover:bg-slate-100'"
                        class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex justify-between items-center">
                        <span v-text="loc.name"></span>
                        <span v-text="loc.count"
                            :class="activeLocations.includes(loc.name) ? 'text-white/80' : 'text-slate-400'"></span>
                    </button>
                </div>
            </div>

            <!-- Stage Filter -->
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider">Filter by Stage</h3>
                    <button v-if="activeStages.length > 0" @click="clearStages()"
                        class="text-xs text-primary hover:underline">Clear</button>
                </div>
                <div class="space-y-1">
                    <button v-for="stg in sortedStages" :key="stg.name" @click="toggleStage(stg.name)"
                        :class="activeStages.includes(stg.name) ? 'bg-primary text-white' : 'bg-slate-50 text-slate-700 hover:bg-slate-100'"
                        class="w-full text-left px-3 py-2 rounded text-sm transition-colors flex justify-between items-center">
                        <span v-text="stg.name"></span>
                        <span v-text="stg.count"
                            :class="activeStages.includes(stg.name) ? 'text-white/80' : 'text-slate-400'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gene Ontology Section (Full Width) -->
    {{ if .Params.gene_ontology }}
    <div class="mt-8">
        <h3 class="text-lg font-bold text-slate-900 mb-3">Gene Ontology</h3>
        <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {{ with .Params.gene_ontology.molecular_function }}
                {{ if gt (len .) 0 }}
                <div>
                    <h4
                        class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">
                        Molecular Function</h4>
                    <ul class="space-y-2">
                        {{ range . }}
                        <li class="text-sm text-slate-700 flex items-start">
                            <span class="text-primary mr-2">•</span>
                            {{ . }}
                        </li>
                        {{ end }}
                    </ul>
                </div>
                {{ end }}
                {{ end }}

                {{ with .Params.gene_ontology.biological_process }}
                {{ if gt (len .) 0 }}
                <div>
                    <h4
                        class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">
                        Biological Process</h4>
                    <ul class="space-y-2">
                        {{ range . }}
                        <li class="text-sm text-slate-700 flex items-start">
                            <span class="text-primary mr-2">•</span>
                            {{ . }}
                        </li>
                        {{ end }}
                    </ul>
                </div>
                {{ end }}
                {{ end }}

                {{ with .Params.gene_ontology.cellular_component }}
                {{ if gt (len .) 0 }}
                <div>
                    <h4
                        class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-3 border-b border-slate-100 pb-2">
                        Cellular Component</h4>
                    <ul class="space-y-2">
                        {{ range . }}
                        <li class="text-sm text-slate-700 flex items-start">
                            <span class="text-primary mr-2">•</span>
                            {{ . }}
                        </li>
                        {{ end }}
                    </ul>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
    </div>
    {{ end }}

    <!-- Orthology Section -->
    {{ if .Params.orthologs }}
    <div class="mt-8">
        <h3 class="text-lg font-bold text-slate-900 mb-3">Orthology</h3>
        <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Species</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Entrez Gene</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Ensembl Gene</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Genetic Phenotypes
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">MOD</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {{ range .Params.orthologs }}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 text-sm text-slate-900 italic">{{ .species }}</td>
                        <td class="px-4 py-2 text-sm text-slate-500 font-mono">
                            {{ if .entrez }}
                            {{ $ids := split (string .entrez) "," }}
                            {{ range $index, $id := $ids }}
                            {{ $cleanId := trim $id " " }}
                            {{ if gt $index 0 }}, {{ end }}
                            <a href="https://www.ncbi.nlm.nih.gov/gene/{{ $cleanId }}" target="_blank"
                                class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ end }}
                            {{ end }}
                        </td>
                        <td class="px-4 py-2 text-sm text-slate-500 font-mono">
                            {{ if .ensembl }}
                            {{ $ids := split (string .ensembl) "," }}
                            {{ range $index, $id := $ids }}
                            {{ $cleanId := trim $id " " }}
                            {{ if gt $index 0 }}, {{ end }}
                            <a href="http://www.ensembl.org/id/{{ $cleanId }}" target="_blank"
                                class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ end }}
                            {{ end }}
                        </td>
                        <td class="px-4 py-2 text-sm text-slate-500">{{ .phenotypes }}</td>
                        <td class="px-4 py-2 text-sm text-slate-500 font-mono">
                            {{ if .mod }}
                            {{ $species := .species }}
                            {{ $ids := split (string .mod) "," }}
                            {{ range $index, $id := $ids }}
                            {{ $cleanId := trim $id " " }}
                            {{ if gt $index 0 }}, {{ end }}

                            {{ if in $cleanId "MIM:" }}
                            <a href="https://www.omim.org/entry/{{ replace $cleanId " MIM:" "" }}" target="_blank"
                                class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ else if in $cleanId "MGI:" }}
                            <a href="http://www.informatics.jax.org/marker/{{ $cleanId }}" target="_blank"
                                class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ else if in $cleanId "ZFIN:" }}
                            <a href="https://zfin.org/{{ replace $cleanId " ZFIN:" "" }}" target="_blank"
                                class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ else if eq $species "Xenopus" }}
                            <a href="http://www.xenbase.org/gene/showgene.do?method=display&geneId={{ $cleanId }}"
                                target="_blank" class="text-primary hover:underline">{{ $cleanId }}</a>
                            {{ else }}
                            {{ $cleanId }}
                            {{ end }}
                            {{ end }}
                            {{ end }}
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>
    {{ end }}

</div>

{{ if or .Params.expression_data .Params.images }}
<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const geneId = {{ .Params.gene_id | jsonify
    }};
    const symbol = {{ .Params.symbol | jsonify }};
    const activeLocations = ref([]);
    const activeStages = ref([]);

    // Prepare data from Hugo params
    const allImages = [
        {{ if .Params.expression_data }}
    {{ range .Params.expression_data }}
    {{ range .entries }}
    {
        url: "{{ with .local_path }}{{ if $.Site.Params.imageBaseURL }}{{ $.Site.Params.imageBaseURL }}{{ $.Params.gene_id }}/{{ path.Base . }}{{ else }}{{ printf "images /% s /% s" $.Params.gene_id (path.Base .) | relURL }}{{ end }}{{ end }}",
            locations: [{{ with .locations }} {{ range . }} {{ . | jsonify }}, {{ end }} {{ end }} {{ with .location }} {{ . | jsonify }} {{ end }}],
    stage: {{ .stage_range | jsonify }},
    source: {{ .source | default "GEISHA" | jsonify }},
    sourceLabel: {{ .source_label | default "GEISHA" | jsonify }}
        },
    {{ end }}
    {{ end }}
    {{ else if .Params.entries }}
    {{ range .Params.entries }}
    {
        url: "{{ with .local_path }}{{ if $.Site.Params.imageBaseURL }}{{ $.Site.Params.imageBaseURL }}{{ $.Params.gene_id }}/{{ path.Base . }}{{ else }}{{ printf "images /% s /% s" $.Params.gene_id (path.Base .) | relURL }}{{ end }}{{ end }}",
            locations: [{{ with .locations }} {{ range . }} {{ . | jsonify }}, {{ end }} {{ end }} {{ with .location }} {{ . | jsonify }} {{ end }}],
    stage: "Unknown"
        },
    {{ end }}
    {{ else if .Params.images }}
    {{ range .Params.images }}
    {
        url: "{{ .image_url | relURL }}",
            locations: [{{ with .location }} {{ . | jsonify }} {{ end }}],
    stage: {{ .stage | default "Unknown" | jsonify }},
    source: {{ .source | default "Publication" | jsonify }},
    sourceLabel: {{ .source_label | default "Publication" | jsonify }}
        },
    {{ end }}
    {{ end }}
        ].filter(img => img.url); // Filter out entries without URLs

    // Normalize locations: split comma-separated strings and deduplicate
    allImages.forEach(img => {
        const normalized = new Set();
        img.locations.forEach(loc => {
            if (loc) {
                loc.split(',').forEach(p => {
                    const clean = p.trim();
                    // Filter out "Not specified" (case-insensitive)
                    if (clean && clean.toLowerCase() !== 'not specified') {
                        normalized.add(clean);
                    }
                });
            }
        });
        img.locations = Array.from(normalized).sort();
    });

    // Extract unique locations with counts
    const locationCounts = {};
    allImages.forEach(img => {
        img.locations.forEach(loc => {
            const cleanLoc = loc.trim();
            if (cleanLoc) {
                locationCounts[cleanLoc] = (locationCounts[cleanLoc] || 0) + 1;
            }
        });
    });

    const sortedLocations = computed(() => {
        return Object.keys(locationCounts).sort().map(loc => ({
            name: loc,
            count: locationCounts[loc]
        }));
    });

    // Extract unique stages with counts
    const stageCounts = {};
    allImages.forEach(img => {
        const stage = img.stage || 'Unknown';
        stageCounts[stage] = (stageCounts[stage] || 0) + 1;
    });

    const sortedStages = computed(() => {
        return Object.keys(stageCounts).sort().map(stage => ({
            name: stage,
            count: stageCounts[stage]
        }));
    });

    // Filter logic
    const filteredImages = computed(() => {
        let result = allImages;

        // Filter by Location (OR logic if multiple selected)
        if (activeLocations.value.length > 0) {
            result = result.filter(img =>
                img.locations.some(loc => activeLocations.value.includes(loc))
            );
        }

        // Filter by Stage (OR logic if multiple selected)
        if (activeStages.value.length > 0) {
            result = result.filter(img => activeStages.value.includes(img.stage));
        }

        return result;
    });

    const toggleLocation = (loc) => {
        const index = activeLocations.value.indexOf(loc);
        if (index === -1) {
            activeLocations.value.push(loc);
        } else {
            activeLocations.value.splice(index, 1);
        }
        nextTick(() => initLightbox());
    };

    const toggleStage = (stage) => {
        const index = activeStages.value.indexOf(stage);
        if (index === -1) {
            activeStages.value.push(stage);
        } else {
            activeStages.value.splice(index, 1);
        }
        nextTick(() => initLightbox());
    };

    const clearLocations = () => {
        activeLocations.value = [];
        nextTick(() => initLightbox());
    };

    const clearStages = () => {
        activeStages.value = [];
        nextTick(() => initLightbox());
    };

    // Lightbox
    let lightboxInstance = null;
    const initLightbox = () => {
        if (lightboxInstance) lightboxInstance.destroy();
        lightboxInstance = GLightbox({
            selector: '.glightbox',
            touchNavigation: true,
            loop: true,
            zoomable: true
        });
    };

    onMounted(() => {
        initLightbox();
    });

    return {
        geneId,
        symbol,
        allImages,
        filteredImages,
        sortedLocations,
        sortedStages,
        activeLocations,
        activeStages,
        toggleLocation,
        toggleStage,
        clearLocations,
        clearStages
    };
    }
}).mount('#gene-app');
</script>{{ end }}
{{ end }}